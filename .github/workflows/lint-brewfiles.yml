name: Lint Brewfiles

on:
  pull_request:
    paths:
      - '**/*.Brewfile'

jobs:
  lint_brewfiles:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Homebrew
        id: set-up-homebrew
        uses: Homebrew/actions/setup-homebrew@main

      - name: Lint Brewfiles
        id: lint
        run: |
          export HOMEBREW_BUNDLE_BREW_SKIP="*"
          export HOMEBREW_BUNDLE_CASK_SKIP="*"
          export HOMEBREW_BUNDLE_MAS_SKIP="*"
          export HOMEBREW_BUNDLE_WHALEBREW_SKIP="*"
          export HOMEBREW_BUNDLE_TAP_SKIP="*"

          files=$(find . -type f -name "*.Brewfile") # Using '.' to search the whole repo
          failed_files=false

          for file in $files; do
            echo "ðŸ” Linting $file"
            # Attempt to run the check command and capture its output (stdout & stderr) if it fails
            if ! output=$(brew bundle check --file="$file" --no-upgrade 2>&1); then
              failed_files=true
              # Print the captured output from brew as a GitHub error annotation
              # This will clearly show which packages are missing for the specific file
              echo "::error file=$file::Linting failed for $file"
              echo "$output"
              echo # Add a newline for better readability in logs
            fi
          done
          
          if [ "$failed_files" = true ]; then
            exit 1
          fi
