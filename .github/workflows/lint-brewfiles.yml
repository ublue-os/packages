- name: Lint Brewfiles
        id: lint
        run: |
          files=$(find . -type f -name "*.Brewfile")
          failed=false

          for file in $files; do
            echo "🔍 Validating packages in $file"
            
            # Read the Brewfile line by line, skipping comments and empty lines
            # Use grep to extract brew, cask, and tap package names
            packages=$(grep -E "^\s*(brew|cask|tap)\s+'" "$file" | sed -E "s/^\s*(brew|cask|tap)\s+'([^']+)'.*/\2/")
            
            if [ -z "$packages" ]; then
              echo "No packages found to validate in $file."
              continue
            fi

            for pkg in $packages; do
              echo "  Validating package: $pkg"
              # Use brew info to check if the package exists. Redirect output to /dev/null.
              if ! brew info "$pkg" > /dev/null 2>&1; then
                echo "::error file=$file::Validation failed. Package '$pkg' in '$file' is invalid or not found."
                failed=true
              fi
            done
          done

          if [ "$failed" = true ]; then
            exit 1
          fi
